USE [SoftCob]
GO
/****** Object:  StoredProcedure [dbo].[sp_RegistroPagosCartera]    Script Date: 9/6/2021 19:07:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_RegistroPagosCartera]
@in_tipo int,
@in_cedecodigo int,
@in_cpcecodigo int,
@in_numerodocumento varchar(20),
@in_operacion varchar(20),
@in_documento varchar(50),
@in_fechaPago varchar(20),
@in_valorpago varchar(10),
@in_tipopago varchar(50),
@in_auxv1 varchar(150),
@in_auxv2 varchar(50),
@in_auxv3 varchar(150),
@in_auxi1 int,
@in_auxi2 int,
@in_auxi3 int,
@in_usucodigo int,
@in_terminal varchar(50)
AS
BEGIN
	DECLARE @cldecodigo int,@valorpagado decimal(12,2),@pacpcodigo int = 0,@pccacodigo int = 0,@continuar int = 0,
		@padecodigo int,@valorexigible decimal(12,2),@totalpagado decimal(12,2), @diasmora int, @rangodias varchar(50),
		@efectivo int,@year int,@mes int,@prcbcodigo int,@cliente varchar(150),@codigoarre int,@respuesta varchar(50)
	
	IF @in_numerodocumento!='' BEGIN							
		SET @cldecodigo=(SELECT CL.CLDE_CODIGO FROM SoftCob_CLIENTE_DEUDOR CL (NOLOCK) WHERE CL.CPCE_CODIGO=@in_cpcecodigo AND CL.PERS_CODIGO in
					(SELECT PE.PERS_CODIGO FROM SoftCob_PERSONA PE (NOLOCK) WHERE PE.pers_numerodocumento=@in_numerodocumento))
	END

	IF(@in_valorpago !='') SET @valorpagado = CONVERT(decimal(12,2),@in_valorpago)
	

	IF @in_tipo = 0 BEGIN --CONSULTAR DATOS DEL CLIENTE TODOS LOS GESTORES POR IDENTIFICACION
		SELECT 
			Cliente = PE.pers_nombrescompletos,
			identificacion = PE.pers_numerodocumento
			FROM SoftCob_PERSONA PE (NOLOCK)
			INNER JOIN SoftCob_CLIENTE_DEUDOR CD (NOLOCK) ON PE.PERS_CODIGO=CD.PERS_CODIGO
		WHERE CD.CPCE_CODIGO=@in_cpcecodigo AND PE.pers_numerodocumento=@in_numerodocumento
	END

	IF @in_tipo = 1 BEGIN --CONSULTAR DATOS DEL CLIENTE TODOS LOS GESTORES POR OPERACION
		SELECT
			Operacion = CL.ctde_operacion,
			Producto = ISNULL((SELECT pade_nombre FROM SoftCob_PARAMETRO_DETALLE (NOLOCK) WHERE pade_valorV=ctde_auxv1 AND PARA_CODIGO in(
						SELECT PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA (NOLOCK) WHERE para_nombre='TIPO PRODUCTO')),
						(SELECT CT.cpce_producto FROM SoftCob_CATALOGO_PRODUCTOS_CEDENTE CT (NOLOCK) WHERE CT.CPCE_CODIGO=CD.CPCE_CODIGO)),
			Deuda = '$' + CAST(CONVERT(varchar(20),CAST(CL.ctde_totaldeuda as money),1) as varchar),
			Saldo = '$' + CAST(CONVERT(varchar(20),CAST(CL.ctde_valorexigible as money),1) as varchar),
			Gestor = (SELECT US.usua_nombres+' '+US.usua_apellidos FROM SoftCob_USUARIO US (NOLOCK) WHERE US.USUA_CODIGO=CL.ctde_gestorasignado),
			Cedula = PE.pers_numerodocumento,
			CodigoCPCE = CD.CPCE_CODIGO,
			SumDeuda = ROUND(CL.ctde_totaldeuda,2,0),
			SumSaldo = ROUND(CL.ctde_valorexigible,2,0),
			CodigoGEST = CL.ctde_gestorasignado,
			DiasMora = CL.ctde_diasmora
			FROM SoftCob_CUENTA_DEUDOR CL (NOLOCK)
			INNER JOIN SoftCob_CLIENTE_DEUDOR CD (NOLOCK) ON CL.CLDE_CODIGO=CD.CLDE_CODIGO
			INNER JOIN SoftCob_PERSONA PE (NOLOCK) ON CD.PERS_CODIGO=PE.PERS_CODIGO
		WHERE CD.CPCE_CODIGO=@in_cpcecodigo AND PE.pers_numerodocumento=@in_numerodocumento 
	END

	IF @in_tipo = 2 BEGIN --CONSULTAR DATOS DEL CLIENTE POR OPERACION
		SELECT
			Cliente = PE.pers_nombrescompletos,
			identificacion = PE.pers_numerodocumento
			FROM SoftCob_PERSONA PE (NOLOCK)
			INNER JOIN SoftCob_CLIENTE_DEUDOR CL (NOLOCK) ON CL.PERS_CODIGO=PE.PERS_CODIGO
			INNER JOIN SoftCob_CUENTA_DEUDOR CD (NOLOCK) ON CD.CLDE_CODIGO=CL.CLDE_CODIGO
		WHERE CL.CPCE_CODIGO=@in_cpcecodigo AND CD.ctde_operacion=@in_operacion
	END

	IF @in_tipo = 3 BEGIN --CONSULTAR DATOS DEL CLIENTE POR OPERACION POR GESTOR
		SELECT ''
	END

	IF @in_tipo = 4 BEGIN --CONSULTAR DE LA CABECERA PARA OBTENER ESTADO 
		SELECT 
			Estado = (SELECT pade_nombre FROM SoftCob_PARAMETRO_DETALLE (NOLOCK) WHERE pade_valorI=PC.pade_codigo AND PARA_CODIGO in
								(SELECT PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA (NOLOCK) WHERE para_nombre='TIPO PAGO'))
			FROM SoftCob_PAGOSCABECERA PC (NOLOCK)
			WHERE PC.pcca_cpcecodigo=@in_cpcecodigo AND PC.pcca_numerodocumento=@in_numerodocumento AND
			PC.pcca_operacion=@in_operacion

		SELECT 
			Estado = CASE CL.clde_estado WHEN 1 THEN 'IMPAGA' ELSE 'IMPAGA SUSPENDIDA' END
			FROM SoftCob_CLIENTE_DEUDOR CL (NOLOCK)
			INNER JOIN SoftCob_PERSONA PE (NOLOCK) ON CL.PERS_CODIGO=PE.PERS_CODIGO
			WHERE CL.CPCE_CODIGO=@in_cpcecodigo AND PE.pers_numerodocumento=@in_numerodocumento
	END

	IF @in_tipo = 5 BEGIN --CONSULTAR PAGODEUDAS DE LA TABLA DE PAGOSCARTERA
		SELECT 
			FechaRegistro = CONVERT(varchar(19),PC.pacp_fechacreacion,121),
			FechaPago = CONVERT(varchar(10),PC.pacp_fechapago,121),
			Pago = '$' + CAST(CONVERT(varchar(20),CAST(PC.pacp_valorpago as money),1) as varchar),
			Documento = PC.pacp_documento,
			Tipo = (SELECT pade_nombre FROM SoftCob_PARAMETRO_DETALLE (NOLOCK) WHERE pade_valorI=PC.pade_codigo AND PARA_CODIGO in
								(SELECT PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA (NOLOCK) WHERE para_nombre='TIPO PAGO')),
			Usuario = US.usua_nombres+' '+US.usua_apellidos,
			Operacion = PC.pacp_operacion,
			Codigo = PC.PACP_CODIGO,
			SumPago = ROUND(PC.pacp_valorpago,2,0)
			FROM SoftCob_PAGOSCARTERA PC (NOLOCK)
				INNER JOIN SoftCob_USUARIO US (NOLOCK) ON PC.pacp_usuariocreacion = US.USUA_CODIGO
			WHERE PC.pacp_cpcecodigo=@in_cpcecodigo AND PC.pacp_numerodocumento=@in_numerodocumento AND
				PC.pacp_operacion=@in_operacion
			ORDER BY PC.pacp_fechapago DESC, PC.pacp_fechacreacion DESC
	END

	IF @in_tipo = 6 BEGIN --RESTAR LOS VALORES DE COBRAN	
		UPDATE SoftCob_CUENTA_DEUDOR SET ctde_estado=0 WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion
		UPDATE SoftCob_LISTATRABAJO_DETALLE SET ltde_estado=0,ltde_gestionado='SI' WHERE ltde_cldecodigo=@cldecodigo AND ltde_auxv1=@in_operacion
		UPDATE SoftCob_REGISTRO_VOLVERALLAMAR SET revl_gestionado='SI' WHERE revl_cldecodigo=@cldecodigo
		IF NOT EXISTS(SELECT 1 FROM SoftCob_CUENTA_DEUDOR (NOLOCK) WHERE CLDE_CODIGO=@cldecodigo AND ctde_estado=1) BEGIN
			UPDATE SoftCob_CLIENTE_DEUDOR SET clde_estado=0 WHERE CPCE_CODIGO=@in_cpcecodigo AND CLDE_CODIGO=@cldecodigo
		END		
		SELECT 'OK'
	END

	IF @in_tipo = 7 BEGIN --ACTUALIZAR EL VALOR DE PAGO REGISTRADO RESTAR

		SET @year = YEAR(CONVERT(date,@in_fechapago,101))
		SET @mes = MONTH(CONVERT(date,@in_fechapago,101))

		UPDATE SoftCob_CUENTA_DEUDOR SET ctde_fechaultimopago=CONVERT(date,@in_fechapago,101),
			ctde_valorexigible=ctde_valorexigible-@valorpagado
			WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion

		SET @valorexigible = (SELECT ctde_valorexigible FROM SoftCob_CUENTA_DEUDOR (NOLOCK) 
								WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion)

		SET @cliente = (SELECT PER.pers_nombrescompletos FROM SoftCob_PERSONA PER (NOLOCK) 
							WHERE PER.pers_numerodocumento=@in_numerodocumento)

		SET @prcbcodigo = (SELECT PYC.PRCB_CODIGO FROM SoftCob_PROYECCION_CAB PYC (NOLOCK) WHERE PYC.prcb_year=@year 
							AND PYC.prcb_mes=@mes AND PYC.prcb_cpcecodigo=@in_cpcecodigo AND PYC.prcb_gestor=@in_auxi1)


		SET @codigoarre = (SELECT TOP 1 RES.ARRE_CODIGO FROM SoftCob_ARBOL_RESPUESTA RES (NOLOCK) WHERE RES.cpcecodigo=@in_cpcecodigo AND
							RES.arre_pago=1 AND RES.arre_auxi2=1 AND RES.arre_estado=1)

		SET @respuesta = (SELECT RES.arre_descripcion FROM SoftCob_ARBOL_RESPUESTA RES (NOLOCK) WHERE RES.ARRE_CODIGO=@codigoarre)

		INSERT INTO SoftCob_REGISTRO_ABONOSPAGO VALUES(0,0,@cldecodigo,@in_auxi1,CONVERT(date,@in_fechapago,101),
			CONVERT(decimal(12,2),@in_valorpago),@valorexigible,0,0,0,0,'',@in_documento,'',0,@in_cpcecodigo,
			@in_auxi2,0,0,GETDATE(),@in_usucodigo,@in_terminal)

		IF @in_auxi2 = 1 BEGIN --PAGO EFECTIVO			
			UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PGR',prde_fechapago=CONVERT(date,@in_fechapago,101),
				prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_auxv2=@in_documento WHERE
				PRCB_CODIGO=(SELECT PRCB_CODIGO FROM SoftCob_PROYECCION_CAB (NOLOCK) WHERE prcb_cpcecodigo=@in_cpcecodigo AND
								prcb_year=@year AND prcb_mes=@mes AND prcb_gestor=@in_auxi1)
				AND prde_cedula=@in_numerodocumento AND prde_auxi1=1 AND prde_auxv2=''

			IF NOT EXISTS(SELECT 1 FROM SoftCob_PROYECCION_DET PYD (NOLOCK) 
							WHERE PYD.prde_cedula=@in_numerodocumento AND 
							CONVERT(DATE,PYD.prde_fechapago,101)=CONVERT(DATE,@in_fechapago,101) AND PYD.prde_auxi1=1
							AND PYD.prde_auxv2=@in_documento) BEGIN

				IF @prcbcodigo > 0 BEGIN
					INSERT INTO SoftCob_PROYECCION_DET VALUES(@prcbcodigo,0,@in_numerodocumento,@cliente,CONVERT(date,@in_fechapago,101),
						CONVERT(decimal(12,2),@in_valorpago),'PNR','',1,@codigoarre,@respuesta,
						CONVERT(varchar(10),GETDATE(),23),@in_documento,'',1,0,0)
				END
			END
		END
		ELSE BEGIN
			UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PPR',prde_fechapago=CONVERT(date,@in_fechapago,101),
				prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_auxv2=@in_documento 
				WHERE PRCB_CODIGO=(SELECT PRCB_CODIGO FROM SoftCob_PROYECCION_CAB (NOLOCK) WHERE prcb_cpcecodigo=@in_cpcecodigo AND
								prcb_year=@year AND prcb_mes=@mes AND prcb_gestor=@in_auxi1)
				AND prde_cedula=@in_numerodocumento AND prde_auxi1=1 AND prde_auxv2=''

			IF NOT EXISTS(SELECT 1 FROM SoftCob_PROYECCION_DET PYD (NOLOCK) 
							WHERE PYD.prde_cedula=@in_numerodocumento AND 
							CONVERT(DATE,PYD.prde_fechapago,101)=CONVERT(DATE,@in_fechapago,101) AND PYD.prde_auxi1=1
							AND PYD.prde_auxv2=@in_documento) BEGIN

				IF @prcbcodigo > 0 BEGIN
					INSERT INTO SoftCob_PROYECCION_DET VALUES(@prcbcodigo,0,@in_numerodocumento,@cliente,CONVERT(date,@in_fechapago,101),
						CONVERT(decimal(12,2),@in_valorpago),'PRS','',1,0,'NUEVO AGREGADO',
						CONVERT(varchar(10),GETDATE(),23),@in_documento,'',0,0,0)
				END
			END
		END
		SELECT 'OK'
	END

	IF @in_tipo = 8 BEGIN --REVERSAR PAGOS REALIZADOS

		SET @year = YEAR(CONVERT(date,@in_fechapago,23))
		SET @mes = MONTH(CONVERT(date,@in_fechapago,23))

		SET @pacpcodigo = ISNULL((SELECT PACP_CODIGO FROM SoftCob_PAGOSCARTERA PC (NOLOCK) WHERE PC.pacp_cpcecodigo=@in_cpcecodigo 
									AND PC.pacp_numerodocumento=@in_numerodocumento	AND pacp_operacion=@in_operacion AND 
									pacp_documento=@in_documento),0)
		
		SET @pccacodigo = ISNULL((SELECT PACP_CODIGO FROM SoftCob_PAGOSCABECERA PC (NOLOCK) WHERE PC.pcca_cpcecodigo=@in_cpcecodigo AND 
				PC.pcca_numerodocumento=@in_numerodocumento AND pcca_operacion=@in_operacion),0)
				
		IF @pccacodigo > 0 BEGIN
			IF @pacpcodigo = @pccacodigo BEGIN
				DELETE FROM SoftCob_PAGOSCABECERA WHERE PACP_CODIGO=@pccacodigo
				DELETE FROM SoftCob_PAGOSCARTERA WHERE PACP_CODIGO=@pacpcodigo				
				UPDATE SoftCob_CUENTA_DEUDOR SET ctde_estado=1 WHERE CLDE_CODIGO=@cldecodigo AND 
						ctde_operacion=@in_operacion
				SET @continuar = 1
			END
			ELSE				
				SET @continuar = 0
		END
		ELSE BEGIN
			DELETE FROM SoftCob_PAGOSCARTERA WHERE PACP_CODIGO=@pacpcodigo
			SET @continuar = 1
			
		END

		IF @continuar = 1 BEGIN
			UPDATE SoftCob_CUENTA_DEUDOR SET ctde_valorexigible=ctde_valorexigible+@valorpagado 
				WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion
			UPDATE SoftCob_CLIENTE_DEUDOR SET clde_estado=1 WHERE CPCE_CODIGO=@in_cpcecodigo AND CLDE_CODIGO=@cldecodigo

			DELETE FROM SoftCob_REGISTRO_ABONOSPAGO WHERE rpab_auxi2=@in_cpcecodigo AND rpab_cldecodigo=@cldecodigo
				AND rpab_gestorasignado=@in_auxi1 AND YEAR(rpab_fechapago)=@year AND MONTH(rpab_fechapago)=@mes
				AND rpab_auxv2=@in_documento AND rpab_auxi3=1

			UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PNR',prde_auxv2='' WHERE
				PRCB_CODIGO=(SELECT PRCB_CODIGO FROM SoftCob_PROYECCION_CAB (NOLOCK) WHERE prcb_cpcecodigo=@in_cpcecodigo AND
								prcb_year=YEAR(CONVERT(date,@in_fechapago,23)) 
								AND prcb_mes=MONTH(CONVERT(date,@in_fechapago,23)) AND prcb_gestor=@in_auxi1)
				AND prde_cedula=@in_numerodocumento AND prde_auxv2=@in_documento AND prde_auxi1=1 AND prde_eliminado=0

			DELETE FROM SoftCob_PROYECCION_DET WHERE PRCB_CODIGO=(SELECT PRCB_CODIGO FROM SoftCob_PROYECCION_CAB (NOLOCK) 
										WHERE prcb_cpcecodigo=@in_cpcecodigo AND prcb_year=YEAR(CONVERT(date,@in_fechapago,23)) 
								AND prcb_mes=MONTH(CONVERT(date,@in_fechapago,23)) AND prcb_gestor=@in_auxi1)
				AND prde_cedula=@in_numerodocumento AND prde_auxv2=@in_documento AND prde_auxi1=1 AND prde_eliminado=1

			SELECT 'OK'	
		END
		ELSE 
			SELECT 'Elmine primero el registro que genero PAGO TOTAL'		
	END

	IF @in_tipo = 9 BEGIN --INSERTAR PAGO TOTAL CREAR CABECERA EN CARGA BATCH
		IF(@in_documento!='' AND @in_valorpago!='0') BEGIN
			SET @padecodigo=(SELECT pade_valorI FROM SoftCob_PARAMETRO_DETALLE PD (NOLOCK) WHERE PD.pade_nombre=@in_tipopago AND PARA_CODIGO in(
								SELECT PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA (NOLOCK) WHERE para_nombre='TIPO PAGO'))
			SET @diasmora = ISNULL((SELECT CDE.ctde_diasmora FROM SoftCob_CUENTA_DEUDOR CDE (NOLOCK) 
									INNER JOIN SoftCob_CLIENTE_DEUDOR CLI (NOLOCK)
								ON CDE.CLDE_CODIGO=CLI.CLDE_CODIGO WHERE CLI.CPCE_CODIGO=@in_cpcecodigo 
								AND CDE.CLDE_CODIGO=@in_auxi1 AND ctde_operacion=@in_operacion),0)

			SET @rangodias = ISNULL((SELECT BMD.brmd_brench FROM SoftCob_BRENCHMESCAB BMC (NOLOCK)
								INNER JOIN SoftCob_BRENCHMESDET BMD (NOLOCK) ON BMD.BRMC_CODIGO=BMC.BRMC_CODIGO
								WHERE BMC.brmc_cpcecodigo=@in_cpcecodigo AND BMC.brmc_gestorasignado=@in_auxi3 
								AND BMC.brmc_usuariocierre=0 AND @diasmora BETWEEN BMD.brmd_rangoinicial AND BMD.brmd_rangofinal),'')

			SET @efectivo = ISNULL((SELECT TOP 1 gete_auxi4 FROM SoftCob_GESTION_TELEFONICA (NOLOCK)
								WHERE gete_cpcecodigo=@in_cpcecodigo AND YEAR(gete_fechagestion)=YEAR(CONVERT(DATE,@in_fechaPago,103))
								AND MONTH(gete_fechagestion)=MONTH(CONVERT(DATE,@in_fechaPago,103))
								AND DAY(gete_fechagestion)<=DAY(CONVERT(DATE,@in_fechaPago,103))
								AND gete_gestorasignado=@in_auxi3 AND gete_auxi4=1 AND gete_operacion=@in_operacion
								ORDER BY gete_fechacreacion DESC),0)

			SET @valorexigible = (SELECT ctde_valorexigible FROM SoftCob_CUENTA_DEUDOR (NOLOCK) WHERE CLDE_CODIGO=@in_auxi1 
									AND ctde_operacion=@in_operacion)

			SET @year = YEAR(CONVERT(date,@in_fechapago,103))
			SET @mes = MONTH(CONVERT(date,@in_fechapago,103))

			SET @prcbcodigo = ISNULL((SELECT PYC.PRCB_CODIGO FROM SoftCob_PROYECCION_CAB PYC (NOLOCK) WHERE PYC.prcb_year=@year 
								AND PYC.prcb_mes=@mes AND PYC.prcb_cpcecodigo=@in_cpcecodigo AND PYC.prcb_gestor=@in_auxi3),0)

			SET @cliente = (SELECT PER.pers_nombrescompletos FROM SoftCob_PERSONA PER (NOLOCK) 
							WHERE pers_numerodocumento=@in_numerodocumento)

			SET @codigoarre = 527
			SET @respuesta = (SELECT RES.arre_descripcion FROM SoftCob_ARBOL_RESPUESTA RES (NOLOCK) WHERE RES.ARRE_CODIGO=@codigoarre)
		
			IF @padecodigo>0 BEGIN
				INSERT INTO SoftCob_REGISTRO_ABONOSPAGO VALUES(0,0,@cldecodigo,@in_auxi3,CONVERT(date,@in_fechapago,103),
					CONVERT(decimal(12,2),@in_valorpago),@valorexigible,0,0,0,0,'',@in_documento,'',@in_cedecodigo,
					@in_cpcecodigo,@efectivo,0,0,GETDATE(),@in_usucodigo,@in_terminal)

				IF @efectivo = 1 BEGIN --ACTUALIZAR REGISTRO_ABONOS_PAGOS

					UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PGR',prde_fechapago=CONVERT(date,@in_fechapago,103),
						prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_auxv2=@in_documento WHERE
						PRCB_CODIGO=@prcbcodigo	AND prde_cedula=@in_numerodocumento AND prde_auxi1=1 AND prde_auxv2=''

					IF NOT EXISTS(SELECT 1 FROM SoftCob_PROYECCION_DET PYD (NOLOCK) 
									WHERE PYD.prde_cedula=@in_numerodocumento AND 
									CONVERT(DATE,PYD.prde_fechapago,103)=CONVERT(DATE,@in_fechapago,103) AND PYD.prde_auxi1=1
									AND PYD.prde_auxv2=@in_documento) BEGIN

						IF @prcbcodigo>0 BEGIN
							INSERT INTO SoftCob_PROYECCION_DET VALUES(@prcbcodigo,0,@in_numerodocumento,@cliente,CONVERT(date,@in_fechapago,103),
								CONVERT(decimal(12,2),@in_valorpago),'PGR','',1,@codigoarre,@respuesta,
								CONVERT(varchar(10),GETDATE(),23),@in_documento,'',1,0,0)
						END
					END
				END
				ELSE BEGIN
					UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PPR',prde_fechapago=CONVERT(date,@in_fechapago,103),
						prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_auxv2=@in_documento 
						WHERE PRCB_CODIGO=@prcbcodigo AND prde_cedula=@in_numerodocumento AND prde_auxi1=1 AND prde_auxv2=''
				END

				IF NOT EXISTS(SELECT 1 FROM SoftCob_PAGOSCARTERA (NOLOCK) WHERE pacp_fechapago=CONVERT(date,@in_fechapago,103) 
					AND	 pacp_numerodocumento=@in_numerodocumento AND pacp_documento=@in_documento) BEGIN

					INSERT INTO SoftCob_PAGOSCARTERA VALUES(@padecodigo,@in_cedecodigo,@in_cpcecodigo,@in_numerodocumento,@in_operacion,
						@in_documento,CONVERT(date,@in_fechaPago,103),CONVERT(decimal(12,2),@in_valorpago),@in_auxi3,@diasmora,
						@rangodias,'','',@efectivo,0,GETDATE(),@in_usucodigo,@in_terminal)

					SET @pacpcodigo=SCOPE_IDENTITY()
					DECLARE @resultado decimal(12,2)
					
					UPDATE SoftCob_CUENTA_DEUDOR SET ctde_valorexigible=ctde_valorexigible-@valorpagado,
							ctde_fechaultimopago=CONVERT(date,@in_fechapago,103)
							WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion

					SET @resultado = (SELECT ctde_valorexigible FROM SoftCob_CUENTA_DEUDOR (NOLOCK) 
										WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion)

					IF @padecodigo=2 or @padecodigo=3 or @resultado<=0 BEGIN
						INSERT INTO SoftCob_PAGOSCABECERA VALUES(@pacpcodigo,@padecodigo,@in_cedecodigo,@in_cpcecodigo,
							@in_numerodocumento,@in_operacion,@in_auxv1,@in_auxv2,@in_auxi1,@in_auxi2)

						UPDATE SoftCob_CUENTA_DEUDOR SET ctde_estado=0,ctde_fechaultimopago=CONVERT(date,@in_fechapago,103) 
							WHERE CLDE_CODIGO=@cldecodigo AND ctde_operacion=@in_operacion

						UPDATE SoftCob_LISTATRABAJO_DETALLE SET ltde_estado=0,ltde_gestionado='SI' 
							WHERE ltde_cldecodigo=@cldecodigo AND ltde_auxv1=@in_operacion

						UPDATE SoftCob_REGISTRO_VOLVERALLAMAR SET revl_gestionado='SI' WHERE revl_cldecodigo=@cldecodigo

						IF NOT EXISTS(SELECT 1 FROM SoftCob_CUENTA_DEUDOR (NOLOCK) WHERE CLDE_CODIGO=@cldecodigo 
							AND ctde_estado=1) BEGIN
							UPDATE SoftCob_CLIENTE_DEUDOR SET clde_estado=0 WHERE CPCE_CODIGO=@in_cpcecodigo 
								AND CLDE_CODIGO=@cldecodigo
						END
					END
					SELECT 'OK'
				END
				ELSE SELECT 'NO-1'
			END
			ELSE SELECT 'NO-2'
		END
		ELSE SELECT 'NO-3'
	END

	IF @in_tipo = 10 BEGIN --CONSULTAR DATOS DEL CLIENTE POR OPERACION ESTA ACTIVA
		SELECT TOP 1
			Cliente = PE.pers_nombrescompletos,
			identificacion = PE.pers_numerodocumento,
			Gestor = CD.ctde_gestorasignado,
			CodigoCLDE = CD.CLDE_CODIGO
			FROM SoftCob_PERSONA PE (NOLOCK)
			INNER JOIN SoftCob_CLIENTE_DEUDOR CL (NOLOCK) ON CL.PERS_CODIGO=PE.PERS_CODIGO
			INNER JOIN SoftCob_CUENTA_DEUDOR CD (NOLOCK) ON CD.CLDE_CODIGO=CL.CLDE_CODIGO
		WHERE CL.CPCE_CODIGO=@in_cpcecodigo AND CD.ctde_operacion=@in_operacion AND CD.ctde_estado=1
	END

	IF @in_tipo = 11 BEGIN --INSERTAR PAGO TOTAL CREAR CABECERA EN CARGA BATCH REFFRESH YANBAL
		SET @padecodigo=(SELECT pade_valorI FROM SoftCob_PARAMETRO_DETALLE PD (NOLOCK) WHERE PD.pade_nombre=@in_tipopago AND PARA_CODIGO in(
						SELECT PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA (NOLOCK) WHERE para_nombre='TIPO PAGO'))

		SET @in_numerodocumento=(SELECT pers_numerodocumento FROM SoftCob_PERSONA (NOLOCK) WHERE PERS_CODIGO=@in_auxi2)

		SET @valorexigible = (SELECT ctde_valorexigible FROM SoftCob_CUENTA_DEUDOR (NOLOCK) WHERE CLDE_CODIGO=@in_auxi1 AND ctde_operacion=@in_operacion)

		SET @diasmora = ISNULL((SELECT CDE.ctde_diasmora FROM SoftCob_CUENTA_DEUDOR CDE (NOLOCK) 
								INNER JOIN SoftCob_CLIENTE_DEUDOR CLI (NOLOCK) ON CDE.CLDE_CODIGO=CLI.CLDE_CODIGO 
								WHERE CLI.CPCE_CODIGO=@in_cpcecodigo AND CDE.CLDE_CODIGO=@in_auxi1 AND ctde_operacion=@in_operacion),0)

		SET @rangodias = ISNULL((SELECT BMD.brmd_brench FROM SoftCob_BRENCHMESCAB BMC (NOLOCK)
							INNER JOIN SoftCob_BRENCHMESDET BMD (NOLOCK) ON BMD.BRMC_CODIGO=BMC.BRMC_CODIGO
							WHERE BMC.brmc_cpcecodigo=@in_cpcecodigo AND BMC.brmc_gestorasignado=CONVERT(int,@in_auxv2)
							AND BMC.brmc_usuariocierre=0 AND @diasmora BETWEEN BMD.brmd_rangoinicial AND BMD.brmd_rangofinal),'')

		SET @efectivo = ISNULL((SELECT TOP 1 gete_auxi4 FROM SoftCob_GESTION_TELEFONICA (NOLOCK)
								WHERE gete_cpcecodigo=@in_cpcecodigo AND YEAR(gete_fechagestion)=YEAR(CONVERT(DATE,@in_fechaPago,121))
								AND MONTH(gete_fechagestion)=MONTH(CONVERT(DATE,@in_fechaPago,121))
								AND DAY(gete_fechagestion)<=DAY(CONVERT(DATE,@in_fechaPago,121))
								AND gete_gestorasignado=CONVERT(int,@in_auxv2) AND gete_auxi4=1 
								AND gete_operacion=@in_operacion ORDER BY gete_fechacreacion DESC),0)

		SET @year = YEAR(CONVERT(date,@in_fechapago,121))
		SET @mes = MONTH(CONVERT(date,@in_fechapago,121))

		UPDATE SoftCob_CUENTA_DEUDOR SET ctde_auxi1=@in_auxi3,ctde_valorexigible=@valorpagado
				WHERE CLDE_CODIGO=@in_auxi1 AND ctde_operacion=@in_operacion

		INSERT INTO SoftCob_REGISTRO_ABONOSPAGO VALUES(0,0,@in_auxi1,CONVERT(int,@in_auxv2),CONVERT(date,@in_fechapago,121),
			CONVERT(decimal(12,2),@in_valorpago),@valorexigible,0,0,0,0,'',@in_documento,'',@in_cedecodigo,@in_cpcecodigo,
			@efectivo,0,0,GETDATE(),@in_usucodigo,@in_terminal)

		SET @prcbcodigo = (SELECT PYC.PRCB_CODIGO FROM SoftCob_PROYECCION_CAB PYC (NOLOCK) WHERE PYC.prcb_year=@year 
							AND PYC.prcb_mes=@mes AND PYC.prcb_cpcecodigo=@in_cpcecodigo AND 
							PYC.prcb_gestor=CONVERT(int,@in_auxv2))

		SET @cliente = (SELECT PER.pers_nombrescompletos FROM SoftCob_PERSONA PER (NOLOCK) WHERE PERS_CODIGO=@in_auxi2)

		SET @codigoarre = 57

		IF @padecodigo=2 or @padecodigo=3 BEGIN
			SET @codigoarre = 58
		END

		SET @respuesta = (SELECT RES.arre_descripcion FROM SoftCob_ARBOL_RESPUESTA RES (NOLOCK) WHERE RES.ARRE_CODIGO=@codigoarre)

		IF @efectivo = 1 BEGIN --ACTUALIZAR REGISTRO_ABONOS_PAGOS
			UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PGR',prde_fechapago=CONVERT(date,@in_fechapago,121),
				prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_auxv2=@in_documento WHERE
				PRCB_CODIGO=(SELECT PRCB_CODIGO FROM SoftCob_PROYECCION_CAB (NOLOCK) WHERE prcb_cpcecodigo=@in_cpcecodigo AND
								prcb_year=@year AND prcb_mes=@mes AND prcb_gestor=CONVERT(int,@in_auxv2))
				AND prde_cedula=@in_numerodocumento AND prde_auxi1=1 AND prde_auxv2=''

			IF NOT EXISTS(SELECT 1 FROM SoftCob_PROYECCION_DET PYD (NOLOCK) 
							WHERE PYD.prde_cedula=@in_numerodocumento AND 
							CONVERT(DATE,PYD.prde_fechapago,121)=CONVERT(DATE,@in_fechapago,121) AND PYD.prde_auxi1=1
							AND PYD.prde_auxv2=@in_documento) BEGIN

				IF @prcbcodigo > 0 BEGIN
					INSERT INTO SoftCob_PROYECCION_DET VALUES(@prcbcodigo,0,@in_numerodocumento,@cliente,CONVERT(date,@in_fechapago,121),
						CONVERT(decimal(12,2),@in_valorpago),'PGR','',1,@codigoarre,@respuesta,
						CONVERT(varchar(10),GETDATE(),23),@in_documento,'',1,0,0)
				END
			END
		END
		ELSE BEGIN
			UPDATE SoftCob_PROYECCION_DET SET prde_estadopago='PPR',prde_fechapago=CONVERT(date,@in_fechapago,121),
				prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_auxv2=@in_documento 
				WHERE PRCB_CODIGO=(SELECT PRCB_CODIGO FROM SoftCob_PROYECCION_CAB (NOLOCK) WHERE prcb_cpcecodigo=@in_cpcecodigo AND
								prcb_year=YEAR(CONVERT(date,@in_fechapago,121)) 
								AND prcb_mes=MONTH(CONVERT(date,@in_fechapago,121)) AND prcb_gestor=CONVERT(int,@in_auxv2))
				AND prde_cedula=@in_numerodocumento AND prde_auxi1=1 AND prde_auxv2=''
		END

		SET @totalpagado = @valorexigible - @valorpagado

		IF @valorpagado < @valorexigible BEGIN
			IF @padecodigo > 0 BEGIN
				IF NOT EXISTS(SELECT 1 FROM SoftCob_PAGOSCARTERA (NOLOCK) WHERE pacp_fechapago=CONVERT(date,@in_fechapago,121) 
						AND pacp_numerodocumento=@in_numerodocumento AND pacp_documento=@in_documento 
						AND pacp_operacion=@in_operacion AND pacp_cedecodigo=@in_cedecodigo AND pacp_cpcecodigo=@in_cpcecodigo) BEGIN
					
					INSERT INTO SoftCob_PAGOSCARTERA VALUES(@padecodigo,@in_cedecodigo,@in_cpcecodigo,@in_numerodocumento,
						@in_operacion,@in_documento,CONVERT(date,@in_fechaPago,121),@totalpagado,CONVERT(int,@in_auxv2),
						@diasmora,@rangodias,'','',	@efectivo,0,GETDATE(),@in_usucodigo,@in_terminal)
					
					SET @pacpcodigo=SCOPE_IDENTITY()
					
					UPDATE SoftCob_CUENTA_DEUDOR SET ctde_valorexigible=@valorpagado,ctde_fechaultimopago=CONVERT(date,@in_fechapago,121)
							WHERE CLDE_CODIGO=@in_auxi1 AND ctde_operacion=@in_operacion

					IF @padecodigo=2 or @padecodigo=3 BEGIN
						INSERT INTO SoftCob_PAGOSCABECERA VALUES(@pacpcodigo,@padecodigo,@in_cedecodigo,@in_cpcecodigo,
						@in_numerodocumento,@in_operacion,'','',0,0)

						UPDATE SoftCob_CUENTA_DEUDOR SET ctde_estado=0,ctde_fechaultimopago=CONVERT(date,@in_fechapago,121) 
							WHERE CLDE_CODIGO=@in_auxi1 AND ctde_operacion=@in_operacion

						UPDATE SoftCob_LISTATRABAJO_DETALLE SET ltde_estado=0,ltde_gestionado='SI' 
								WHERE ltde_cldecodigo=@in_auxi1 AND ltde_auxv1=@in_operacion AND
								ltde_gestionado='NO'

						UPDATE SoftCob_REGISTRO_VOLVERALLAMAR SET revl_gestionado='SI' 
							WHERE revl_cldecodigo=@in_auxi1 AND revl_gestionado='NO'
					END
					SELECT 'OK'
				END
				ELSE SELECT 'NO'
			END
			ELSE SELECT 'NO'
		END 
		ELSE SELECT 'NO'
	END

	IF @in_tipo = 12 BEGIN --CONSULTAR SI EXISTE UN PAGO EFECTIVO EN LAS GESTIONES POR GESTOR
		SELECT top 1
			Operacion = GTE.gete_operacion,
			Efectivo = GTE.gete_efectivo
		FROM SoftCob_GESTION_TELEFONICA GTE (NOLOCK)
		INNER JOIN SoftCob_CUENTA_DEUDOR CDE (NOLOCK) ON GTE.gete_operacion=GTE.gete_operacion
						AND CDE.ctde_gestorasignado=@in_auxi3
		WHERE GTE.gete_cedecodigo=@in_cedecodigo AND GTE.gete_cpcecodigo=@in_cpcecodigo AND GTE.gete_operacion=@in_operacion
			AND GTE.gete_gestorasignado=@in_auxi3 AND GTE.gete_auxv3='SI' AND year(GTE.gete_fechagestion)=@in_auxi1 AND 
			MONTH(GTE.gete_fechagestion)=@in_auxi2 AND DATEDIFF(day,CONVERT(date,GTE.gete_fechagestion,101),
			DATEADD(day,GTE.gete_auxi2,CONVERT(date,@in_fechaPago,101)))>=0 
			ORDER BY GTE.gete_fechacreacion DESC
	END

	IF @in_tipo = 13 BEGIN --REGISTRAR LOS PAGO EN BRENCHCABGESTOR PARA CONTROLOS FECHA DEL PAGO REALIZADO POR GESTOR
		IF NOT EXISTS(SELECT 1 FROM SoftCob_BRENCHGESTORCAB (NOLOCK) WHERE gebc_cedecodigo=@in_cedecodigo AND gebc_cpcecodigo=@in_cpcecodigo
					AND gebc_gestor=@in_auxi1 AND gebc_fechapago=CONVERT(date,@in_fechapago,101) AND
					gebc_aniobrench=@in_auxi2 AND gebc_mesbrench=@in_auxi3) BEGIN
			INSERT INTO SoftCob_BRENCHGESTORCAB VALUES(@in_cedecodigo,@in_cpcecodigo,@in_auxi1,
					CONVERT(date,@in_fechapago,101),CONVERT(decimal(12,2),@in_valorpago),@in_auxi2,@in_auxi3,
					'',@in_auxv2,@in_auxv3,'',0,0,0,0,0,0,0,0,GETDATE(),@in_usucodigo,@in_terminal,GETDATE(),@in_usucodigo,
					@in_terminal)
		END
		ELSE BEGIN
			UPDATE SoftCob_BRENCHGESTORCAB SET gebc_totalpago=gebc_totalpago+CONVERT(decimal(12,2),@in_valorpago)
				WHERE gebc_cedecodigo=@in_cedecodigo AND gebc_cpcecodigo=@in_cpcecodigo
					AND gebc_gestor=@in_auxi1 AND gebc_fechapago=CONVERT(date,@in_fechapago,101) AND
					gebc_aniobrench=@in_auxi2 AND gebc_mesbrench=@in_auxi3
		END

		IF @in_auxv1='SI' BEGIN
			UPDATE SoftCob_BRENCHMESCAB SET brmc_fechacierre=GETDATE(),brmc_usuariocierre=@in_usucodigo,
				brmc_terminalcierre=@in_terminal WHERE brmc_cedecodigo=@in_cedecodigo AND brmc_cpcecodigo=@in_cpcecodigo AND
				brmc_gestorasignado=@in_auxi1 AND brmc_presupuestoanio=@in_auxi2 AND brmc_presupuestomes=@in_auxi3
		END
	END

	IF @in_tipo = 14 BEGIN
		DECLARE @brench varchar(50),@rangoini int, @rangofin int,@gestor int,@pbcacodigo int,
			@fechagestion varchar(10)
		SET @gestor = (SELECT ctde_gestorasignado FROM SoftCob_CUENTA_DEUDOR CDE (NOLOCK) 
							INNER JOIN SoftCob_CLIENTE_DEUDOR CLI (NOLOCK) ON CDE.CLDE_CODIGO=CLI.CLDE_CODIGO
							WHERE CLI.CPCE_CODIGO=@in_cpcecodigo AND CDE.ctde_operacion=@in_operacion)
		SET @diasmora = (SELECT ctde_diasmora FROM SoftCob_CUENTA_DEUDOR CDE (NOLOCK)
							INNER JOIN SoftCob_CLIENTE_DEUDOR CLI (NOLOCK) ON CDE.CLDE_CODIGO=CLI.CLDE_CODIGO
							WHERE CLI.CPCE_CODIGO=@in_cpcecodigo AND CDE.ctde_operacion=@in_operacion)
		--DETERMINAR SI LA OPERACION CUMPLE LAS CONDICIONES DE PAGO
		-- Sea efectiva
		--- que la gestion sea igual o menor a la fecha de pago
		--SELECT * FROM SoftCob_GESTION_TELEFONICA WHERE 
		SET @fechagestion = ISNULL((SELECT top 1 CONVERT(varchar(10),gete_fechagestion,101) 
								FROM SoftCob_GESTION_TELEFONICA (NOLOCK) WHERE gete_cedecodigo=@in_cedecodigo AND 
								gete_cpcecodigo=@in_cpcecodigo AND gete_operacion=@in_operacion AND gete_efectivo=1 AND 
								gete_auxv3='SI' AND	YEAR(gete_fechagestion)=@in_auxi1 AND 
								MONTH(gete_fechagestion)=@in_auxi2 ORDER BY gete_fechagestion DESC),'12/31/2999')

		IF CONVERT(date,@fechagestion,101)<=CONVERT(date,@in_fechapago,101) BEGIN
			IF EXISTS(SELECT 1 FROM SoftCob_BRENCHMESDET BMD (NOLOCK)
						INNER JOIN SoftCob_BRENCHMESCAB BMC (NOLOCK) ON BMD.BRMC_CODIGO=BMC.BRMC_CODIGO
						WHERE BMC.brmc_cedecodigo=@in_cedecodigo AND BMC.brmc_cpcecodigo=@in_cpcecodigo
						AND BMC.brmc_presupuestoanio=@in_auxi1 AND brmc_presupuestomes=@in_auxi2 AND
						brmc_gestorasignado=@gestor AND @diasmora BETWEEN BMD.brmd_rangoinicial AND
						BMD.brmd_rangofinal) BEGIN

				SET @brench = (SELECT BMD.brmd_brench FROM SoftCob_BRENCHMESDET BMD (NOLOCK)
						INNER JOIN SoftCob_BRENCHMESCAB BMC (NOLOCK) ON BMD.BRMC_CODIGO=BMC.BRMC_CODIGO
						WHERE BMC.brmc_cedecodigo=@in_cedecodigo AND BMC.brmc_cpcecodigo=@in_cpcecodigo
						AND BMC.brmc_presupuestoanio=@in_auxi1 AND brmc_presupuestomes=@in_auxi2 AND
						brmc_gestorasignado=@gestor AND @diasmora BETWEEN BMD.brmd_rangoinicial AND
						BMD.brmd_rangofinal)

				SET @rangoini = (SELECT BMD.brmd_rangoinicial FROM SoftCob_BRENCHMESDET BMD (NOLOCK)
						INNER JOIN SoftCob_BRENCHMESCAB BMC (NOLOCK) ON BMD.BRMC_CODIGO=BMC.BRMC_CODIGO
						WHERE BMC.brmc_cedecodigo=@in_cedecodigo AND BMC.brmc_cpcecodigo=@in_cpcecodigo
						AND BMC.brmc_presupuestoanio=@in_auxi1 AND brmc_presupuestomes=@in_auxi2 AND
						brmc_gestorasignado=@gestor AND @diasmora BETWEEN BMD.brmd_rangoinicial AND
						BMD.brmd_rangofinal)

				SET @rangofin = (SELECT BMD.brmd_rangofinal FROM SoftCob_BRENCHMESDET BMD (NOLOCK)
						INNER JOIN SoftCob_BRENCHMESCAB BMC (NOLOCK) ON BMD.BRMC_CODIGO=BMC.BRMC_CODIGO
						WHERE BMC.brmc_cedecodigo=@in_cedecodigo AND BMC.brmc_cpcecodigo=@in_cpcecodigo
						AND BMC.brmc_presupuestoanio=@in_auxi1 AND brmc_presupuestomes=@in_auxi2 AND
						brmc_gestorasignado=@gestor AND @diasmora BETWEEN BMD.brmd_rangoinicial AND
						BMD.brmd_rangofinal)

				INSERT INTO SoftCob_PAGOSBRENCH_CAB VALUES(@in_cedecodigo,@in_cpcecodigo,@gestor,CONVERT(date,@in_auxv1,101),
					@in_auxi1,@in_auxi2,@in_auxv2,'','','',0,0,0,GETDATE(),@in_usucodigo,@in_terminal)
				SET @pbcacodigo = SCOPE_IDENTITY()

				INSERT INTO SoftCob_PAGOSBRENCH_DET VALUES(@pbcacodigo,@in_operacion,@diasmora,CONVERT(date,@in_fechapago,101),
						@brench,@rangoini,@rangofin,'','','',0,0,0)
				SELECT 'OK'
			END
		END
	END

	IF @in_tipo = 15 BEGIN --CONSULTAR PROYECCION CAB
		SELECT
			Presupuesto = PYC.prcb_presupuesto,
			Proyeccion = PYC.prcb_proyeccion,
			CodigoPRCB = PYC.PRCB_CODIGO
		FROM SoftCob_PROYECCION_CAB PYC (NOLOCK)
		WHERE PYC.prcb_cedecodigo=@in_cedecodigo AND PYC.prcb_cpcecodigo=@in_cpcecodigo AND PYC.prcb_gestor=@in_auxi1 AND
			PYC.prcb_year=@in_auxi2 AND PYC.prcb_mes=@in_auxi3
	END

	--IF @in_tipo = 16 BEGIN --CONSULTAR SI EXISTE PROYECCION REGISTRADA DEL GESTOR X MES Y AÃ‘O
	--	SELECT
	--		CodigoRESP = PDE.PRDE_CODIGO,
	--		Cedula = PDE.prde_cedula,
	--		Cliente = PDE.prde_cliente,
	--		FechaPago = CONVERT(VARCHAR(10),PDE.prde_fechapago,23),
	--		Valor = PDE.prde_valor,
	--		EstadoPago = PDE.prde_estadopago,
	--		Respuesta = PDE.prde_respuesta,
	--		Observacion = PDE.prde_observacion,
	--		Eliminado = CASE PDE.prde_eliminado WHEN 0 THEN 'NO' ELSE 'SI' END,
	--		CodigoARRE = PDE.prde_codigoarre,
	--		CodigoPRCB = CAST(PCA.PRCB_CODIGO AS varchar)
	--	FROM
	--		SoftCob_PROYECCION_DET PDE (NOLOCK)
	--		INNER JOIN SoftCob_PROYECCION_CAB PCA (NOLOCK) ON PDE.PRCB_CODIGO=PCA.PRCB_CODIGO
	--		WHERE PCA.prcb_cedecodigo=@in_cedecodigo AND PCA.prcb_cpcecodigo=@in_cpcecodigo AND
	--		PCA.prcb_gestor=@in_auxi1 AND PCA.prcb_year=@in_auxi2 AND PCA.prcb_mes=@in_auxi3 
	--	ORDER BY Cedula,FechaPago
	--END

	IF @in_tipo = 17 BEGIN --CONSULTAR SI EXISTE PROYECCION REGISTRADA DEL GESTOR X MES Y ANIO	
	
		UPDATE SoftCob_PROYECCION_CAB SET prcb_meslabel=@in_auxv1,prcb_presupuesto=CONVERT(decimal(12,2),@in_auxv2)
			WHERE prcb_cedecodigo=@in_cedecodigo AND prcb_cpcecodigo=@in_cpcecodigo AND prcb_gestor=@in_auxi1 
			AND prcb_year=@in_auxi2 AND prcb_mes=@in_auxi3

		SELECT
			CodigoRESP = PDE.PRDE_CODIGO,
			Cedula = PDE.prde_cedula,
			Cliente = PDE.prde_cliente,
			FechaPago = CONVERT(VARCHAR(10),PDE.prde_fechapago,23),
			Valor = PDE.prde_valor,
			Documento = PDE.prde_auxv2,
			EstadoPago = (SELECT PRD.pade_nombre FROM SoftCob_PARAMETRO_DETALLE PRD (NOLOCK) WHERE PRD.pade_valorV=PDE.prde_estadopago
							AND PRD.PARA_CODIGO=(SELECT PRC.PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA PRC (NOLOCK) 
													WHERE PRC.para_nombre='ESTADO PROYECCION')),
			Respuesta = PDE.prde_respuesta,
			Observacion = PDE.prde_observacion,
			Eliminado = CASE PDE.prde_eliminado WHEN 0 THEN 'NO' ELSE 'SI' END,
			CodigoARRE = PDE.prde_codigoarre,
			CodigoPRCB = CAST(PCA.PRCB_CODIGO AS varchar),
			CodigoESTA = PDE.prde_estadopago,
			FechaGestion = PDE.prde_auxv1			
		FROM
			SoftCob_PROYECCION_DET PDE (NOLOCK)
			INNER JOIN SoftCob_PROYECCION_CAB PCA (NOLOCK) ON PDE.PRCB_CODIGO=PCA.PRCB_CODIGO
			WHERE PCA.prcb_cedecodigo=@in_cedecodigo AND PCA.prcb_cpcecodigo=@in_cpcecodigo AND
			PCA.prcb_gestor=@in_auxi1 AND PCA.prcb_year=@in_auxi2 AND PCA.prcb_mes=@in_auxi3		
	END

	IF @in_tipo = 18 BEGIN --INSERTAR NUEVO REIGSTRO EN PROYECCION
		INSERT INTO SoftCob_PROYECCION_DET VALUES(@in_auxi1,@in_auxi2,@in_numerodocumento,@in_auxv1,
			CONVERT(VARCHAR(10),@in_fechaPago,111),CONVERT(decimal(12,2),@in_valorpago),@in_auxv2,
			@in_auxv3,0,@in_auxi3,@in_tipopago,'','','',0,0,0)
		SELECT 'OK-Insert'
	END

	IF @in_tipo = 19 BEGIN ---ACTUALIZAR DATOS DE PROYECCION
		UPDATE SoftCob_PROYECCION_DET SET prde_fechapago=CONVERT(VARCHAR(10),@in_fechaPago,23),
			prde_valor=CONVERT(decimal(12,2),@in_valorpago),prde_observacion=@in_auxv1,
			prde_estadopago=@in_auxv2
		WHERE PRDE_CODIGO=@in_auxi1

		SELECT 'OK-Update'
	END

	IF @in_tipo = 20 BEGIN --ELIMINAR DATOS DE PROYECCION BORRADO LOGICO
		DELETE FROM SoftCob_PROYECCION_DET WHERE PRDE_CODIGO=@in_auxi1 
		SELECT 'OK-Del'
	END

	IF @in_tipo = 21 BEGIN --BUSCAR SI EXISTE PAGO REGISTRADO EN LA FECHA
		SELECT
			ValorPago = pacp_valorpago,
			Documento = pacp_documento,
			FechaPago = CONVERT(VARCHAR(10),pacp_fechapago,23)
		FROM SoftCob_PAGOSCARTERA (NOLOCK)
		WHERE pacp_cpcecodigo=@in_cpcecodigo AND YEAR(pacp_fechapago)=@in_auxi1 AND MONTH(pacp_fechapago)=@in_auxi2
		AND pacp_numerodocumento=@in_numerodocumento AND pacp_gestor=@in_auxi3-- AND pacp_auxi1=1
	END

	IF @in_tipo = 22 BEGIN --CONSULTAR REGISTROS PRESUPUESTO DETALLE
		SELECT
			CodigoRESP = PRDE_CODIGO,
			Cedula = PDE.prde_cedula,
			Cliente = PDE.prde_cliente,
			FechaPago = CONVERT(VARCHAR(10),PDE.prde_fechapago,23),
			Valor = PDE.prde_valor,
			Documento = PDE.prde_auxv2,
			EstadoPago = (SELECT PRD.pade_nombre FROM SoftCob_PARAMETRO_DETALLE PRD (NOLOCK) WHERE PRD.pade_valorV=PDE.prde_estadopago
							AND PRD.PARA_CODIGO=(SELECT PRC.PARA_CODIGO FROM SoftCob_PARAMETRO_CABECERA PRC (NOLOCK) 
													WHERE PRC.para_nombre='ESTADO PROYECCION')),
			Respuesta = PDE.prde_respuesta,
			Observacion = PDE.prde_observacion,
			Eliminado = CASE PDE.prde_eliminado WHEN 0 THEN 'NO' ELSE 'SI' END,
			CodigoARRE = PDE.prde_codigoarre,
			CodigoPRCB = CAST(PCA.PRCB_CODIGO AS varchar),
			CodigoESTA = PDE.prde_estadopago,
			FechaGestion = PDE.prde_auxv1
		FROM
			SoftCob_PROYECCION_DET PDE (NOLOCK)
			INNER JOIN SoftCob_PROYECCION_CAB PCA (NOLOCK) ON PDE.PRCB_CODIGO=PCA.PRCB_CODIGO
			WHERE PCA.PRCB_CODIGO=@in_auxi1
	END

	IF @in_tipo = 23 BEGIN --LISTAR PAGOS PERDIDOS PARA ACTUALIZAR
		SELECT 
			Identificacion = PYD.prde_cedula,
			Cliente = PYD.prde_cliente,
			FechaGestion = PYD.prde_auxv1,
			FechaPago = CONVERT(VARCHAR(10),PYD.prde_fechapago,121),
			Valor = PYD.prde_valor,
			CodigoPROY = PYD.PRDE_CODIGO,
			CodigoPERS = PYD.prde_auxi2
			FROM SoftCob_PROYECCION_DET PYD (NOLOCK)
			INNER JOIN SoftCob_PROYECCION_CAB PYC (NOLOCK) ON PYD.PRCB_CODIGO=PYC.PRCB_CODIGO
		WHERE PYC.prcb_cedecodigo=@in_cedecodigo AND PYC.prcb_cpcecodigo=@in_cpcecodigo AND PYC.prcb_year=@in_auxi1 
		AND PYC.prcb_mes=@in_auxi2 AND PYC.prcb_gestor=@in_auxi3 AND PYD.prde_estadopago=@in_tipopago
	END

END
